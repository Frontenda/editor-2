<html>
<head>
<title>source/packager</title>
<style>
body{
    margin: 0 auto;
    font-family: Georgia, Palatino, serif;
    color: #444444;
    line-height: 1;
    max-width: 960px;
    padding: 30px;
}
h1, h2, h3, h4 {
    color: #111111;
    font-weight: 400;
}
h1, h2, h3, h4, h5, p {
    margin-bottom: 24px;
    padding: 0;
}
h1 {
    font-size: 48px;
}
h2 {
    font-size: 36px;
    /* The bottom margin is small. It's designed to be used with gray meta text
     * below a post title. */
    margin: 24px 0 6px;
}
h3 {
    font-size: 24px;
}
h4 {
    font-size: 21px;
}
h5 {
    font-size: 18px;
}
a {
    color: #0099ff;
    margin: 0;
    padding: 0;
    vertical-align: baseline;
}
a:hover {
    text-decoration: none;
    color: #ff6600;
}
a:visited {
    color: purple;
}
ul, ol {
    padding: 0;
    margin: 0;
}
li {
    line-height: 24px;
}
li ul, li ul {
    margin-left: 24px;
}
p, ul, ol {
    font-size: 16px;
    line-height: 24px;
    max-width: 540px;
}
pre {
    padding: 0px 24px;
    max-width: 800px;
    white-space: pre-wrap;
}
code {
    font-family: Consolas, Monaco, Andale Mono, monospace;
    line-height: 1.5;
    font-size: 13px;
}
aside {
    display: block;
    float: right;
    width: 390px;
}
blockquote {
    border-left:.5em solid #eee;
    padding: 0 2em;
    margin-left:0;
    max-width: 476px;
}
blockquote  cite {
    font-size:14px;
    line-height:20px;
    color:#bfbfbf;
}
blockquote cite:before {
    content: '\2014 \00A0';
}

blockquote p {  
    color: #666;
    max-width: 460px;
}
hr {
    width: 540px;
    text-align: left;
    margin: 0 auto 0 0;
    color: #999;
}
</style>
</head>
<body>
<h1>
<a name="packager" class="anchor" href="#packager"><span class="octicon octicon-link"></span></a>Packager</h1>

<p>The main responsibilities will be bundling dependencies, and creating the
package.</p>

<pre><code>Packager = -&gt;
  collectDependencies: (dependencies) -&gt;
    names = Object.keys(dependencies)

    $.when.apply(null, names.map (name) -&gt;
      value = dependencies[name]

      if typeof value is "string"
</code></pre>

<p>If our string is an absolute URL then we assume that the server is CORS enabled
and we can make a cross origin request to collect the JSON data.</p>

<pre><code>        if value.startsWith("http")
          $.getJSON(value)
        else
</code></pre>

<p>Handle a Github repo dependency. Something like <code>STRd6/issues:master</code>. This uses
JSONP to load the package from the gh-pages branch of the given repo.</p>

<p><code>STRd6/issues:master</code> will be accessible at <code>http://strd6.github.io/issues/master.jsonp</code>.
The callback is the same as the repo info string: <code>window["STRd6/issues:master"](... JSON DATA ...)</code></p>

<p>Why all the madness? Github pages doesn't allow CORS right now, so we need to use
the JSONP hack to work around it. Because the files are static we can't allow the
server to generate a wrapper in response to our query string param so we need to
work out a unique one per file ahead of time. The <code>&lt;user&gt;/&lt;repo&gt;:&lt;ref&gt;</code> string is 
unique for all our packages so we use it to determine the URL and name callback.</p>

<pre><code>          if (match = value.match(/([^\/]*)\/([^\:]*)\:(.*)/))
            [callback, user, repo, branch] = match

            user = user.toLowerCase()

            $.ajax
              url: "http://#{user}.github.io/#{repo}/#{branch}.jsonp"
              dataType: "jsonp"
              jsonpCallback: callback
              cache: true
          else
            reject """
              Failed to parse repository info string #{value}, be sure it's in the 
              form `&lt;user&gt;/&lt;repo&gt;:&lt;ref&gt;` for example: `STRd6/issues:master`
              or `STRd6/editor:v0.9.1`
            """
      else
        reject "Can only handle url string dependencies right now"
    ).then (results...) -&gt;
      # WTF: jQuery.when behaves differently for one argument than it does for
      # two or more.
      if names.length is 1
        results = [results]

      bundledDependencies = {}

      names.each (name, i) -&gt;
        bundledDependencies[name] = results[i][0]

      return bundledDependencies
</code></pre>

<p>Create the standalone components of this package. An html page that loads the 
main entry point for demonstration purposes and a json package that can be
used as a dependency in other packages.</p>

<pre><code>  standAlone: (pkg) -&gt;
    {source, distribution, entryPoint} = pkg

    html = """
      &lt;!doctype html&gt;
      &lt;head&gt;
      &lt;meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /&gt;
      #{dependencyScripts(pkg.remoteDependencies)}
      &lt;/head&gt;
      &lt;body&gt;
      &lt;script&gt;
      #{packageWrapper(pkg, "require('./#{entryPoint}')")}
      &lt;\/script&gt;
      &lt;/body&gt;
      &lt;/html&gt;
    """

    json = JSON.stringify(pkg, null, 2)

    html: html
    js: program(pkg)
    json: json
    jsonp: jsonpWrapper(pkg.repository, json)
</code></pre>

<p>Generates a standalone page for testing the app.</p>

<pre><code>  testScripts: (pkg) -&gt;
    {distribution} = pkg

    testProgram = Object.keys(distribution).select (path) -&gt;
      path.match /test\//
    .map (testPath) -&gt;
      "require('./#{testPath}')"
    .join "\n"

    """
      #{dependencyScripts(pkg.remoteDependencies)}
      &lt;script&gt;
        #{packageWrapper(pkg, testProgram)}
      &lt;\/script&gt;
    """

module.exports = Packager
</code></pre>

<h2>
<a name="helpers" class="anchor" href="#helpers"><span class="octicon octicon-link"></span></a>Helpers</h2>

<p>Create a rejected deferred with the given message.</p>

<pre><code>reject = (message) -&gt;
  Deferred().reject([message])
</code></pre>

<p><code>makeScript</code> returns a string representation of a script tag. Don't use this
with tons of stuff stuck inside as html, it gets messed up. Using with src is
fine though.</p>

<pre><code>makeScript = (attrs) -&gt;
  $("&lt;script&gt;", attrs).prop('outerHTML')
</code></pre>

<p><code>dependencyScripts</code> returns a string containing the script tags that are
the dependencies of this build.</p>

<pre><code>dependencyScripts = (remoteDependencies=[]) -&gt;
  remoteDependencies.map (src) -&gt;
    makeScript
      class: "env"
      src: src

  .join("\n")
</code></pre>

<p>A standalone JS program for the package. Does not use <code>require</code> and is only
suitable for script style dependencies.</p>

<pre><code>program = ({distribution, entryPoint}) -&gt;
  if main = distribution[entryPoint]
    return main.content
  else
    # TODO: We should emit some kind of user-visible warning
    console.warn "Entry point #{entryPoint} not found."

    return ""
</code></pre>

<p>Wraps the given data in a JSONP function wrapper. This allows us to host our
packages on Github pages and get around any same origin issues by using JSONP.</p>

<pre><code>jsonpWrapper = (repository, data) -&gt;
  """
    window["#{repository.full_name}:#{repository.branch}"](#{data});
  """
</code></pre>

<p>Wrap code in a closure that provides the package and a require function. This
can be used for generating standalone HTML pages, scripts, and tests.</p>

<pre><code>packageWrapper = (pkg, code) -&gt;
  """
    ;(function(PACKAGE) {
    var require = Require.generateFor(PACKAGE);
    #{code}
    })(#{JSON.stringify(pkg, null, 2)});
  """
</code></pre>
</body>
</html>